services:
  # üöÄ Traefik Reverse Proxy
  traefik:
    image: traefik:v2.10
    container_name: ds2025-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - demo_net
    restart: always

  # üìä Shared PostgreSQL Database
  postgres:
    image: postgres:17
    container_name: ds2025-postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: postgres
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - demo_net

  # üêá RabbitMQ Message Broker
  # RabbitMQ = broker de mesaje √Æntre microservicii.
  # Serviciile trimit »ôi consumƒÉ evenimente prin cozi (asincron).
  # UserService ‚Üí trimite USER_CREATED ‚Üí DeviceService consumƒÉ.
  # DeviceService ‚Üí trimite DEVICE_CREATED ‚Üí MonitoringService consumƒÉ.
  # DeviceSimulator ‚Üí trimite valori ‚Üí MonitoringService agregƒÉ.

  rabbitmq:
    image: rabbitmq:3-management
    container_name: ds2025-rabbitmq
    restart: always
    ports:
      - "5672:5672"    # port pentru microservicii
      - "15672:15672"  # port pentru UI (rabbitmq dashboard)
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - demo_net

  # üîê Authorization Service
  authorization-service:
    build: ./AuthorizationService
    container_name: ds2025-authorization-service
    depends_on:
      postgres:
        condition: service_healthy
      traefik:
        condition: service_started
    environment:
      DB_IP: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: root
      DB_DBNAME: auth-db
      PORT: 8083
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=PathPrefix(`/api/auth`)"
      - "traefik.http.routers.auth.entrypoints=web"
      - "traefik.http.services.auth.loadbalancer.server.port=8083"
    networks:
      - demo_net

  # üë• User Service
  user-service:
    build: ./demo
    container_name: ds2025-user-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_started
      traefik:
        condition: service_started
    environment:
      DB_IP: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: root
      DB_DBNAME: example-db
      PORT: 8081
      AUTH_SERVICE_URL: http://authorization-service:8083
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user.rule=PathPrefix(`/api/users`)"
      - "traefik.http.routers.user.entrypoints=web"
      - "traefik.http.services.user.loadbalancer.server.port=8081"
    networks:
      - demo_net

  # ‚öôÔ∏è Device Service
  device-service:
    build: ./DeviceMicroService
    container_name: ds2025-device-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_started
      traefik:
        condition: service_started
    environment:
      DB_IP: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: root
      DB_DBNAME: device-db
      PORT: 8082
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.device.rule=PathPrefix(`/api/devices`)"
      - "traefik.http.routers.device.entrypoints=web"
      - "traefik.http.services.device.loadbalancer.server.port=8082"
    networks:
      - demo_net

  # üìà Monitoring Service
  monitoring-service:
    build: ./monitoring-service
    container_name: ds2025-monitoring-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_started
      traefik:
        condition: service_started
    environment:
      DB_IP: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: root
      DB_DBNAME: monitoring-db
      PORT: 8084
      SECURITY_JWT_SECRET: 4C6F76654A617661537072696E67426F6F744A57544831323334353637383930313233
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.monitoring.rule=PathPrefix(`/api/monitoring`)"
      - "traefik.http.routers.monitoring.entrypoints=web"
      - "traefik.http.services.monitoring.loadbalancer.server.port=8084"
    networks:
      - demo_net

  # üé® Frontend Application
  frontend:
    build: ./simple-frontend
    container_name: ds2025-frontend
    depends_on:
      user-service:
        condition: service_started
      device-service:
        condition: service_started
      traefik:
        condition: service_started
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.priority=1"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
    networks:
      - demo_net


networks:
  demo_net:
    name: ds2025_demo_net
    driver: bridge

volumes:
  postgres_data:
    name: ds2025_postgres_data
